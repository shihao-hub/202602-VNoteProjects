# 模块五：MCP（Model Context Protocol）

> 掌握 AI 与外部世界的连接标准

---

## 第16章：MCP 概述与设计理念

### 16.1 MCP 是什么

**MCP（Model Context Protocol，模型上下文协议）** 是一个开放标准，定义了 AI 应用（如 LLM）与外部数据源、工具之间的通信方式。

```
简单理解：

MCP 是 AI 世界的"USB 标准"

USB 出现前：                    USB 出现后：
┌─────────┐                    ┌─────────┐
│ 打印机  │ ─专用线─           │ 打印机  │ ─┐
├─────────┤                    ├─────────┤  │
│ 扫描仪  │ ─另一种线─ 电脑    │ 扫描仪  │ ─┤ USB ─ 电脑
├─────────┤                    ├─────────┤  │
│ 键盘    │ ─又一种线─         │ 键盘    │ ─┤
├─────────┤                    ├─────────┤  │
│ 鼠标    │ ─还有一种─         │ 鼠标    │ ─┘
└─────────┘                    └─────────┘
每个设备需要专用接口            统一接口，即插即用

MCP 出现前：                    MCP 出现后：
┌─────────┐                    ┌─────────┐
│ GitHub  │ ─专用API─          │ GitHub  │ ─┐
├─────────┤                    ├─────────┤  │
│ 数据库  │ ─另一套─   AI      │ 数据库  │ ─┤ MCP ─ AI
├─────────┤                    ├─────────┤  │
│ 文件系统│ ─又一套─           │ 文件系统│ ─┤
├─────────┤                    ├─────────┤  │
│ Slack   │ ─还有一套─         │ Slack   │ ─┘
└─────────┘                    └─────────┘
每个服务需要专门适配            统一协议，通用连接
```

### 16.2 为什么需要 MCP

```
MCP 解决的核心问题：

问题 1：集成成本高
─────────────────────────────────────────
没有 MCP：
• 每个 AI 应用都要单独对接每个服务
• 10 个 AI 应用 × 10 个服务 = 100 种集成
• 大量重复工作

有 MCP：
• 每个服务只需实现一次 MCP Server
• 任何支持 MCP 的 AI 应用都能使用
• 10 + 10 = 20 种实现，而不是 100 种

问题 2：缺乏标准
─────────────────────────────────────────
没有 MCP：
• 每个工具的调用方式不同
• 参数格式不统一
• 错误处理各异

有 MCP：
• 统一的工具定义格式
• 标准化的调用流程
• 一致的错误处理

问题 3：安全与权限
─────────────────────────────────────────
MCP 提供：
• 明确的权限边界
• 用户确认机制
• 安全的通信方式
```

### 16.3 MCP 解决的痛点

```
开发者的痛点：

痛点 1："我需要让 AI 读取我的数据库"
─────────────────────────────────────────
以前：自己写一大堆适配代码
现在：用现成的 MCP Database Server

痛点 2："我想让 AI 操作我的 GitHub"
─────────────────────────────────────────
以前：学习 GitHub API，写认证逻辑，处理各种边界情况
现在：用 GitHub MCP Server，开箱即用

痛点 3："我开发了一个服务，想让各种 AI 都能用"
─────────────────────────────────────────
以前：为每个 AI 平台单独适配
现在：实现一个 MCP Server，所有支持 MCP 的 AI 都能用

用户的痛点：

痛点 4："AI 不能访问我的本地文件"
─────────────────────────────────────────
以前：手动复制粘贴文件内容
现在：MCP 让 AI 能安全地读取本地文件

痛点 5："AI 不知道我的项目上下文"
─────────────────────────────────────────
以前：每次都要解释项目背景
现在：MCP Server 可以提供项目上下文
```

### 16.4 类比理解

> **MCP 是 AI 世界的"USB 接口标准"**

```
更详细的类比：

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  USB 的世界                    MCP 的世界               │
│  ══════════                    ══════════               │
│                                                         │
│  USB 设备                      MCP Server               │
│  (U盘、键盘、打印机)           (GitHub、数据库、文件系统)│
│                                                         │
│  USB 接口                      MCP 协议                 │
│  (物理标准+通信协议)           (通信标准+数据格式)       │
│                                                         │
│  USB 主机                      MCP Host                 │
│  (电脑)                        (AI 应用，如 Claude)     │
│                                                         │
│  USB 驱动                      MCP Client               │
│  (让系统识别设备)              (让 AI 应用使用 Server)   │
│                                                         │
│  即插即用                      即装即用                 │
│  插上就能用                    配置好 Server 就能用     │
│                                                         │
└─────────────────────────────────────────────────────────┘

为什么 USB 成功？
• 统一标准，减少了混乱
• 降低了设备制造商的成本
• 用户体验大幅提升

MCP 的目标同样如此：
• 统一 AI 与外部服务的连接方式
• 降低工具开发者的集成成本
• 让用户能轻松扩展 AI 的能力
```

---

## 第17章：MCP 架构与核心概念

### 17.1 Host、Client、Server 三层架构

```
MCP 的三层架构：

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  ┌──────────────────────────────────────────────────┐  │
│  │                   MCP Host                        │  │
│  │            (如 Claude Desktop, Qoder)             │  │
│  │                                                   │  │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐          │  │
│  │  │ Client 1│  │ Client 2│  │ Client 3│          │  │
│  │  └────┬────┘  └────┬────┘  └────┬────┘          │  │
│  │       │            │            │                │  │
│  └───────┼────────────┼────────────┼────────────────┘  │
│          │            │            │                    │
│          │    MCP 协议 │            │                    │
│          │            │            │                    │
│          ▼            ▼            ▼                    │
│  ┌─────────┐   ┌─────────┐   ┌─────────┐              │
│  │ Server 1│   │ Server 2│   │ Server 3│              │
│  │ (GitHub)│   │(Database)│   │ (Files) │              │
│  └─────────┘   └─────────┘   └─────────┘              │
│                                                         │
└─────────────────────────────────────────────────────────┘

各层职责：

Host（宿主）：
• 用户直接使用的 AI 应用
• 管理多个 Client
• 决定何时调用哪个工具
• 示例：Claude Desktop、Qoder CLI

Client（客户端）：
• Host 内部的组件
• 与特定 Server 建立连接
• 转发工具调用请求
• 处理 Server 的响应

Server（服务器）：
• 提供具体功能的服务
• 暴露 Tools、Resources、Prompts
• 执行实际操作
• 示例：GitHub Server、Database Server
```

### 17.2 Resources（资源）

```
Resources = MCP Server 暴露的数据源

┌─────────────────────────────────────────────────────────┐
│                   Resources 概念                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  什么是 Resource：                                      │
│  • Server 可以提供给 AI 的数据                         │
│  • 类似于 REST API 中的资源端点                        │
│  • 可以是文件、数据库记录、API 数据等                  │
│                                                         │
│  Resource 的特点：                                      │
│  • 有唯一的 URI 标识                                   │
│  • 可以被读取                                          │
│  • 可以订阅更新                                        │
│                                                         │
│  示例：                                                 │
│  ┌───────────────────────────────────────────────┐     │
│  │ URI: file:///Users/me/project/README.md       │     │
│  │ Type: text/markdown                           │     │
│  │ Description: Project README file              │     │
│  └───────────────────────────────────────────────┘     │
│                                                         │
│  ┌───────────────────────────────────────────────┐     │
│  │ URI: db://myapp/users/123                     │     │
│  │ Type: application/json                        │     │
│  │ Description: User record with ID 123          │     │
│  └───────────────────────────────────────────────┘     │
│                                                         │
└─────────────────────────────────────────────────────────┘

Resources vs Tools 的区别：
• Resources：被动提供数据（AI 读取）
• Tools：主动执行操作（AI 调用）
```

### 17.3 Tools（工具）

```
Tools = MCP Server 暴露的可执行操作

┌─────────────────────────────────────────────────────────┐
│                    Tools 概念                           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  什么是 Tool：                                          │
│  • AI 可以调用的函数/操作                              │
│  • 有明确的输入参数和输出                              │
│  • 执行具体的动作                                      │
│                                                         │
│  Tool 的定义结构：                                      │
│  ┌───────────────────────────────────────────────┐     │
│  │ {                                             │     │
│  │   "name": "create_issue",                     │     │
│  │   "description": "在 GitHub 创建一个 Issue", │     │
│  │   "inputSchema": {                            │     │
│  │     "type": "object",                         │     │
│  │     "properties": {                           │     │
│  │       "repo": {                               │     │
│  │         "type": "string",                     │     │
│  │         "description": "仓库名称"            │     │
│  │       },                                      │     │
│  │       "title": {                              │     │
│  │         "type": "string",                     │     │
│  │         "description": "Issue 标题"          │     │
│  │       },                                      │     │
│  │       "body": {                               │     │
│  │         "type": "string",                     │     │
│  │         "description": "Issue 内容"          │     │
│  │       }                                       │     │
│  │     },                                        │     │
│  │     "required": ["repo", "title"]             │     │
│  │   }                                           │     │
│  │ }                                             │     │
│  └───────────────────────────────────────────────┘     │
│                                                         │
│  AI 如何使用 Tool：                                     │
│  1. AI 看到可用的 Tools 列表和描述                     │
│  2. 根据用户请求决定使用哪个 Tool                      │
│  3. 构造符合 inputSchema 的参数                        │
│  4. 调用 Tool，等待结果                                │
│  5. 根据结果继续对话或采取下一步行动                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 17.4 Prompts（提示模板）

```
Prompts = MCP Server 提供的预定义提示模板

┌─────────────────────────────────────────────────────────┐
│                   Prompts 概念                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  什么是 Prompt Template：                               │
│  • Server 预定义的、可复用的提示模板                   │
│  • 可以包含参数，让用户填充                            │
│  • 封装了最佳实践和领域知识                            │
│                                                         │
│  示例：                                                 │
│  ┌───────────────────────────────────────────────┐     │
│  │ {                                             │     │
│  │   "name": "code_review",                      │     │
│  │   "description": "代码审查提示模板",          │     │
│  │   "arguments": [                              │     │
│  │     {                                         │     │
│  │       "name": "code",                         │     │
│  │       "description": "要审查的代码",          │     │
│  │       "required": true                        │     │
│  │     },                                        │     │
│  │     {                                         │     │
│  │       "name": "language",                     │     │
│  │       "description": "编程语言",              │     │
│  │       "required": false                       │     │
│  │     }                                         │     │
│  │   ]                                           │     │
│  │ }                                             │     │
│  └───────────────────────────────────────────────┘     │
│                                                         │
│  用途：                                                 │
│  • 标准化常见任务的提示                                │
│  • 确保一致的输出质量                                  │
│  • 降低用户编写 Prompt 的门槛                          │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 17.5 Sampling（采样请求）

```
Sampling = Server 向 AI 请求生成内容

┌─────────────────────────────────────────────────────────┐
│                   Sampling 概念                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  什么是 Sampling：                                      │
│  • Server 请求 Host 中的 AI 生成内容                   │
│  • 与普通 Tool 调用方向相反                            │
│  • 让 Server 能够利用 AI 的能力                        │
│                                                         │
│  普通流程 vs Sampling：                                 │
│                                                         │
│  普通 Tool 调用：                                       │
│  AI ──(调用工具)──▶ Server ──(执行)──▶ 返回结果      │
│                                                         │
│  Sampling：                                             │
│  Server ──(请求AI生成)──▶ AI ──(生成内容)──▶ 返回    │
│                                                         │
│  使用场景：                                             │
│  • Server 需要 AI 帮忙处理某些任务                     │
│  • 例如：分析日志、总结内容、生成代码                  │
│                                                         │
│  安全考虑：                                             │
│  • Host 可以控制是否允许 Sampling                      │
│  • 用户可能需要确认                                    │
│  • 防止滥用 AI 资源                                    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 第18章：MCP Server 与 Tools

### 18.1 MCP Server 的职责

```
MCP Server 是功能提供者

┌─────────────────────────────────────────────────────────┐
│                 MCP Server 的职责                       │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  1. 暴露能力                                            │
│  ────────────                                           │
│  • 声明自己提供哪些 Tools                              │
│  • 声明自己提供哪些 Resources                          │
│  • 声明自己提供哪些 Prompts                            │
│                                                         │
│  2. 处理请求                                            │
│  ────────────                                           │
│  • 接收来自 Client 的调用请求                          │
│  • 验证参数                                            │
│  • 执行实际操作                                        │
│  • 返回结果或错误                                      │
│                                                         │
│  3. 管理状态                                            │
│  ────────────                                           │
│  • 维护连接状态                                        │
│  • 管理认证信息                                        │
│  • 处理资源更新通知                                    │
│                                                         │
│  4. 安全保障                                            │
│  ────────────                                           │
│  • 验证权限                                            │
│  • 防止恶意操作                                        │
│  • 记录审计日志                                        │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### 18.2 Tool 的定义与规范

```
Tool 定义的完整结构：

┌─────────────────────────────────────────────────────────┐
│ {                                                       │
│   // 工具名称（唯一标识）                               │
│   "name": "search_code",                                │
│                                                         │
│   // 工具描述（帮助 AI 理解何时使用）                  │
│   "description": "在代码库中搜索指定的文本或模式。     │
│                   支持正则表达式。返回匹配的文件和行。",│
│                                                         │
│   // 输入参数的 JSON Schema                             │
│   "inputSchema": {                                      │
│     "type": "object",                                   │
│     "properties": {                                     │
│       "query": {                                        │
│         "type": "string",                               │
│         "description": "搜索关键词或正则表达式"        │
│       },                                                │
│       "path": {                                         │
│         "type": "string",                               │
│         "description": "搜索的目录路径",               │
│         "default": "."                                  │
│       },                                                │
│       "include": {                                      │
│         "type": "string",                               │
│         "description": "文件名模式，如 *.py"           │
│       },                                                │
│       "caseSensitive": {                                │
│         "type": "boolean",                              │
│         "description": "是否区分大小写",               │
│         "default": false                                │
│       }                                                 │
│     },                                                  │
│     "required": ["query"]                               │
│   }                                                     │
│ }                                                       │
└─────────────────────────────────────────────────────────┘

好的 Tool 定义原则：

✅ 名称清晰：一看就知道做什么
✅ 描述详尽：包含使用场景和限制
✅ 参数完整：必填和可选参数分明
✅ 类型准确：使用正确的 JSON Schema 类型
✅ 默认值合理：减少必须传的参数
```

### 18.3 输入输出 Schema

```
输入 Schema（inputSchema）：

定义 Tool 接受什么参数：
┌─────────────────────────────────────────────────────────┐
│ "inputSchema": {                                        │
│   "type": "object",                                     │
│   "properties": {                                       │
│     "filename": {                                       │
│       "type": "string",                                 │
│       "description": "文件名"                          │
│     },                                                  │
│     "content": {                                        │
│       "type": "string",                                 │
│       "description": "文件内容"                        │
│     },                                                  │
│     "overwrite": {                                      │
│       "type": "boolean",                                │
│       "description": "是否覆盖已存在的文件",           │
│       "default": false                                  │
│     }                                                   │
│   },                                                    │
│   "required": ["filename", "content"]                   │
│ }                                                       │
└─────────────────────────────────────────────────────────┘

输出格式：

Tool 执行后返回的结果：
┌─────────────────────────────────────────────────────────┐
│ // 成功的响应                                           │
│ {                                                       │
│   "content": [                                          │
│     {                                                   │
│       "type": "text",                                   │
│       "text": "文件已创建：/path/to/file.txt"         │
│     }                                                   │
│   ]                                                     │
│ }                                                       │
│                                                         │
│ // 错误的响应                                           │
│ {                                                       │
│   "isError": true,                                      │
│   "content": [                                          │
│     {                                                   │
│       "type": "text",                                   │
│       "text": "错误：文件已存在且 overwrite=false"    │
│     }                                                   │
│   ]                                                     │
│ }                                                       │
└─────────────────────────────────────────────────────────┘
```

### 18.4 常见 MCP Server 示例

```
官方和社区提供的 MCP Server：

┌─────────────────────────────────────────────────────────┐
│                  常见 MCP Server                        │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  文件系统 (Filesystem)                                  │
│  ─────────────────────                                  │
│  • 读取/写入/删除文件                                  │
│  • 列出目录内容                                        │
│  • 搜索文件                                            │
│                                                         │
│  GitHub                                                 │
│  ──────                                                 │
│  • 管理 Issues 和 PRs                                  │
│  • 读取仓库内容                                        │
│  • 搜索代码                                            │
│                                                         │
│  数据库 (PostgreSQL, SQLite)                           │
│  ───────────────────────────                            │
│  • 执行 SQL 查询                                       │
│  • 读取表结构                                          │
│  • 数据导出                                            │
│                                                         │
│  浏览器 (Browser/Puppeteer)                            │
│  ─────────────────────────                              │
│  • 打开网页                                            │
│  • 截图                                                │
│  • 提取内容                                            │
│                                                         │
│  Slack/Discord                                          │
│  ─────────────                                          │
│  • 发送消息                                            │
│  • 读取频道历史                                        │
│  • 管理频道                                            │
│                                                         │
│  搜索引擎                                               │
│  ──────────                                             │
│  • 网络搜索                                            │
│  • 获取搜索结果                                        │
│                                                         │
└─────────────────────────────────────────────────────────┘

如何找到更多 MCP Server：
• GitHub: github.com/modelcontextprotocol/servers
• npm: 搜索 "mcp-server"
• 社区列表和 Awesome 仓库
```

---

## 第19章：MCP 实践应用

### 19.1 如何发现和使用 MCP Server

```
使用 MCP Server 的步骤：

步骤 1：发现可用的 Server
──────────────────────────
• 浏览官方 Server 仓库
• 搜索社区贡献的 Server
• 根据需要选择

步骤 2：安装 Server
──────────────────────────
通常通过 npm 或 pip 安装：

# npm 安装
npm install -g @modelcontextprotocol/server-github

# 或者 pip
pip install mcp-server-sqlite

步骤 3：配置 Host 使用 Server
──────────────────────────
在 AI 应用的配置文件中添加 Server：

示例（claude_desktop_config.json）：
{
  "mcpServers": {
    "github": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-github"],
      "env": {
        "GITHUB_TOKEN": "your_token"
      }
    }
  }
}

步骤 4：使用
──────────────────────────
重启 AI 应用，新的工具就可用了！
```

### 19.2 常用 MCP Server 推荐

```
按使用场景推荐：

开发者常用
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

filesystem
├── 用途：读写本地文件
├── 安装：@modelcontextprotocol/server-filesystem
└── 场景：让 AI 操作项目文件

github
├── 用途：GitHub 操作
├── 安装：@modelcontextprotocol/server-github
└── 场景：管理 Issues、PRs、查看代码

sqlite / postgres
├── 用途：数据库操作
├── 安装：@modelcontextprotocol/server-sqlite
└── 场景：查询和管理数据库

通用工具
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

brave-search
├── 用途：网络搜索
├── 安装：@modelcontextprotocol/server-brave-search
└── 场景：获取实时信息

fetch
├── 用途：HTTP 请求
├── 安装：@modelcontextprotocol/server-fetch
└── 场景：访问 API、抓取网页

memory
├── 用途：持久化记忆
├── 安装：@modelcontextprotocol/server-memory
└── 场景：跨会话记住信息
```

### 19.3 MCP 在 Qoder 中的应用

```
Qoder 使用 MCP 的方式：

┌─────────────────────────────────────────────────────────┐
│                                                         │
│   Qoder CLI (Host)                                     │
│   ┌─────────────────────────────────────────────────┐  │
│   │                                                 │  │
│   │   内置 MCP Client                               │  │
│   │   ├── 连接配置的 MCP Servers                   │  │
│   │   ├── 将 Tools 暴露给 AI                       │  │
│   │   └── 处理 Tool 调用                           │  │
│   │                                                 │  │
│   │   AI (Claude)                                   │  │
│   │   ├── 看到所有可用的 MCP Tools                 │  │
│   │   ├── 决定使用哪个 Tool                        │  │
│   │   └── 生成调用参数                             │  │
│   │                                                 │  │
│   └─────────────────────────────────────────────────┘  │
│                        │                                │
│                        │ MCP 协议                       │
│                        │                                │
│   ┌────────────────────┼────────────────────────────┐  │
│   │                    │                            │  │
│   ▼                    ▼                            ▼  │
│ ┌─────────┐      ┌─────────┐                ┌─────────┐│
│ │ Browser │      │  Quest  │                │ Custom  ││
│ │ Server  │      │ Server  │                │ Server  ││
│ └─────────┘      └─────────┘                └─────────┘│
│                                                         │
└─────────────────────────────────────────────────────────┘

在 Qoder 中你可以看到的 MCP Tools：
• mcp__browser-use__* : 浏览器操作工具
• mcp__quest__* : 代码搜索和记忆工具
• 其他你配置的 MCP Server 的工具
```

### 19.4 MCP Server 开发入门

```
开发一个简单的 MCP Server：

步骤 1：了解 SDK
──────────────────────────
官方提供 TypeScript 和 Python SDK：
• TypeScript: @modelcontextprotocol/sdk
• Python: mcp

步骤 2：基本结构（TypeScript 示例）
──────────────────────────
```typescript
import { Server } from "@modelcontextprotocol/sdk/server/index.js";
import { StdioServerTransport } from "@modelcontextprotocol/sdk/server/stdio.js";

// 创建 Server
const server = new Server({
  name: "my-server",
  version: "1.0.0"
}, {
  capabilities: {
    tools: {}
  }
});

// 定义 Tools
server.setRequestHandler("tools/list", async () => ({
  tools: [{
    name: "hello",
    description: "打个招呼",
    inputSchema: {
      type: "object",
      properties: {
        name: { type: "string", description: "你的名字" }
      },
      required: ["name"]
    }
  }]
}));

// 处理 Tool 调用
server.setRequestHandler("tools/call", async (request) => {
  if (request.params.name === "hello") {
    const name = request.params.arguments.name;
    return {
      content: [{
        type: "text",
        text: `你好，${name}！`
      }]
    };
  }
});

// 启动 Server
const transport = new StdioServerTransport();
await server.connect(transport);
```

```
步骤 3：测试
──────────────────────────
配置到 AI 应用中，调用测试

步骤 4：发布（可选）
──────────────────────────
打包并发布到 npm 或 pypi
```

---

## 本章小结

```
核心要点回顾：

1. MCP 是什么
   ├── AI 与外部服务的连接标准
   ├── 类似于 USB 接口标准
   └── 让工具开发者一次实现，到处使用

2. MCP 架构
   ├── Host：AI 应用（如 Claude、Qoder）
   ├── Client：Host 内的连接组件
   ├── Server：提供功能的服务
   └── 三层协作完成工具调用

3. 核心概念
   ├── Resources：可读取的数据源
   ├── Tools：可执行的操作
   ├── Prompts：预定义的提示模板
   └── Sampling：Server 请求 AI 生成

4. 实践应用
   ├── 发现和安装 MCP Server
   ├── 配置 AI 应用使用 Server
   └── 开发自定义 MCP Server
```

---

**下一章 → [第20章：RAG 原理与架构](./06-rag-vector-db.md)**
