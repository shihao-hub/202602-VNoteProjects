# 模块三：AI Agents（智能体）

> 理解有"手脚"的 AI 系统

---

## 第9章：什么是 Agent

### 9.1 Agent 的定义

**Agent（智能体）** 是一个能够自主感知环境、做出决策并采取行动的 AI 系统。

```
简单理解：

纯 LLM：只能"说"
   ┌──────────┐
   │   用户   │ ──问题──▶ │   LLM    │ ──回答──▶ │  用户  │
   └──────────┘           └──────────┘           └────────┘

Agent：能"说"也能"做"
   ┌──────────┐           ┌──────────┐           ┌────────┐
   │   用户   │ ──任务──▶ │  Agent   │ ──结果──▶ │  用户  │
   └──────────┘           └────┬─────┘           └────────┘
                               │
                    ┌──────────┼──────────┐
                    ▼          ▼          ▼
               ┌────────┐ ┌────────┐ ┌────────┐
               │读取文件│ │执行代码│ │搜索网络│
               └────────┘ └────────┘ └────────┘
```

### 9.2 Agent 与纯 LLM 调用的区别

```
┌────────────────────────────────────────────────────────────┐
│ 特性           │ 纯 LLM                │ Agent             │
├────────────────────────────────────────────────────────────┤
│ 交互方式       │ 一问一答              │ 多轮自主执行       │
│ 工具使用       │ 无                    │ 可调用多种工具     │
│ 环境感知       │ 仅靠输入文本          │ 可读取文件、数据库等│
│ 行动能力       │ 只能生成文本          │ 可执行实际操作     │
│ 任务复杂度     │ 简单、单步任务        │ 复杂、多步任务     │
│ 自主性         │ 被动响应              │ 主动规划执行       │
│ 记忆           │ 仅上下文窗口内        │ 可有长期记忆       │
└────────────────────────────────────────────────────────────┘
```

### 9.3 Agent 解决的核心问题

```
问题 1：LLM 无法获取实时信息
─────────────────────────────
用户："今天北京天气怎么样？"
纯 LLM："我无法访问实时数据..." ❌
Agent：[调用天气 API] → "北京今天晴，25°C" ✅

问题 2：LLM 无法执行实际操作
─────────────────────────────
用户："帮我创建一个名为 test 的文件夹"
纯 LLM："你可以使用 mkdir test 命令..." ❌（只能说怎么做）
Agent：[执行 mkdir test] → "已创建 test 文件夹" ✅（直接做了）

问题 3：LLM 无法处理复杂多步任务
─────────────────────────────
用户："分析这个项目的代码质量，找出问题并修复"
纯 LLM：只能给出笼统建议 ❌
Agent：
  1. [读取项目文件]
  2. [分析代码结构]
  3. [运行 lint 工具]
  4. [定位问题]
  5. [修改文件]
  6. [验证修复] ✅
```

### 9.4 类比理解

> **Agent 是"有手有脚的 AI 助手"**

```
想象你雇佣了一个助理：

普通的 ChatBot（纯 LLM）：
┌─────────────────────────────────────────────┐
│ 你："帮我订一张明天去上海的机票"            │
│ Bot："好的，你可以这样订票：                │
│       1. 打开携程 APP                       │
│       2. 搜索航班                           │
│       3. ..."                               │
│                                             │
│ （只能告诉你怎么做，但不能帮你做）          │
└─────────────────────────────────────────────┘

Agent 助理：
┌─────────────────────────────────────────────┐
│ 你："帮我订一张明天去上海的机票"            │
│ Agent："好的，让我帮你处理..."              │
│        [打开订票网站]                       │
│        [搜索明天的航班]                     │
│        [比较价格和时间]                     │
│        [选择合适的航班]                     │
│ Agent："我找到了 3 个选项：                 │
│        A. 8:00 出发，￥680                  │
│        B. 10:30 出发，￥520                 │
│        C. 14:00 出发，￥450                 │
│        您要订哪一个？"                      │
│                                             │
│ （真的在帮你做事）                          │
└─────────────────────────────────────────────┘
```

---

## 第10章：Agent 的核心组件

### 10.1 四大核心组件

```
                    ┌─────────────────────────┐
                    │         Agent          │
                    └───────────┬─────────────┘
                                │
        ┌───────────┬───────────┼───────────┬───────────┐
        │           │           │           │           │
        ▼           ▼           ▼           ▼           │
   ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐     │
   │  大脑   │ │  记忆   │ │  工具   │ │  规划   │     │
   │ (LLM)  │ │(Memory) │ │(Tools) │ │(Planning)│     │
   └─────────┘ └─────────┘ └─────────┘ └─────────┘     │
        │           │           │           │           │
        │           │           │           │           │
        └───────────┴───────────┴───────────┴───────────┘
                                │
                                ▼
                    ┌─────────────────────────┐
                    │     外部环境/世界        │
                    └─────────────────────────┘
```

### 10.2 大脑（LLM）：思考与决策

```
角色：Agent 的核心智能，负责理解和决策

职责：
├── 理解用户意图
├── 分析当前状态
├── 决定下一步行动
├── 生成工具调用参数
└── 整合结果并回复用户

类比：CEO，做出所有重要决策

示例流程：
用户："找出项目中所有的 TODO 注释"

LLM 思考：
"用户想找 TODO 注释
 → 需要搜索代码文件
 → 应该使用 grep 工具
 → 搜索模式应该是 'TODO'
 → 让我调用 grep 工具..."
```

### 10.3 记忆（Memory）：短期与长期

```
┌─────────────────────────────────────────────────────────┐
│                       记忆系统                          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  短期记忆（Working Memory）                             │
│  ─────────────────────────                              │
│  • 当前对话的上下文                                     │
│  • 最近执行的操作和结果                                 │
│  • 临时变量和中间状态                                   │
│  • 存储位置：LLM 的上下文窗口                          │
│  • 生命周期：当前会话                                   │
│                                                         │
│  长期记忆（Long-term Memory）                           │
│  ─────────────────────────                              │
│  • 用户偏好和历史                                       │
│  • 之前的对话摘要                                       │
│  • 学到的知识和经验                                     │
│  • 存储位置：向量数据库/文件                           │
│  • 生命周期：跨会话持久化                              │
│                                                         │
└─────────────────────────────────────────────────────────┘

记忆的作用：

没有记忆的 Agent：
每次对话都像第一次见面，需要重新解释所有背景

有记忆的 Agent：
"上次你提到喜欢简洁的代码风格，这次我按这个偏好生成..."
```

### 10.4 工具（Tools）：与外部世界交互

```
工具 = Agent 的"手和脚"

常见工具类型：
┌────────────────────────────────────────────────────┐
│ 类型            │ 示例                             │
├────────────────────────────────────────────────────┤
│ 文件操作        │ 读取文件、写入文件、删除文件     │
│ 代码执行        │ 运行 Python、执行 Shell 命令     │
│ 网络请求        │ HTTP 请求、API 调用             │
│ 搜索            │ 网络搜索、代码搜索、文档搜索     │
│ 数据库          │ SQL 查询、数据读写               │
│ 外部服务        │ 发邮件、发消息、日历操作         │
│ 浏览器          │ 打开网页、点击、填表             │
└────────────────────────────────────────────────────┘

工具的定义（简化示例）：
{
  "name": "read_file",
  "description": "读取指定路径的文件内容",
  "parameters": {
    "file_path": {
      "type": "string",
      "description": "要读取的文件路径"
    }
  }
}

Agent 如何使用工具：
1. LLM 决定需要使用某个工具
2. LLM 生成工具调用的参数
3. 系统执行工具操作
4. 结果返回给 LLM
5. LLM 根据结果决定下一步
```

### 10.5 规划（Planning）：任务分解与执行

```
规划能力让 Agent 能够处理复杂任务

简单任务（无需规划）：
用户："现在几点了？"
Agent：[调用时间工具] → "现在是下午 3:30"

复杂任务（需要规划）：
用户："帮我重构这个模块，添加单元测试，然后提交代码"

Agent 的规划过程：
┌─────────────────────────────────────────────────┐
│ 任务分解：                                      │
│                                                 │
│ 1. 分析当前模块结构                             │
│    └── [读取相关文件]                           │
│                                                 │
│ 2. 设计重构方案                                 │
│    └── [分析代码，确定改进点]                   │
│                                                 │
│ 3. 执行重构                                     │
│    ├── [修改文件 A]                             │
│    ├── [修改文件 B]                             │
│    └── [更新导入]                               │
│                                                 │
│ 4. 编写单元测试                                 │
│    ├── [创建测试文件]                           │
│    └── [编写测试用例]                           │
│                                                 │
│ 5. 验证                                         │
│    ├── [运行测试]                               │
│    └── [检查代码质量]                           │
│                                                 │
│ 6. 提交代码                                     │
│    ├── [git add]                                │
│    ├── [git commit]                             │
│    └── [生成提交信息]                           │
└─────────────────────────────────────────────────┘
```

---

## 第11章：Agent 的工作流程

### 11.1 感知-思考-行动循环

```
Agent 的基本运行循环：

     ┌──────────────────────────────────────┐
     │                                      │
     │    ┌──────────┐                      │
     │    │   感知   │ ◀─────────────────┐  │
     │    │ Perceive │                   │  │
     │    └────┬─────┘                   │  │
     │         │                         │  │
     │         ▼                         │  │
     │    ┌──────────┐                   │  │
     │    │   思考   │                   │  │
     │    │  Think   │                   │  │
     │    └────┬─────┘                   │  │
     │         │                         │  │
     │         ▼                         │  │
     │    ┌──────────┐                   │  │
     │    │   行动   │ ──────────────────┘  │
     │    │   Act    │                      │
     │    └──────────┘                      │
     │                                      │
     └──────────────────────────────────────┘

每个阶段的内容：

感知（Perceive）：
• 接收用户输入
• 获取工具执行结果
• 读取环境状态

思考（Think）：
• 理解当前状态
• 回顾目标
• 决定下一步行动

行动（Act）：
• 调用工具
• 生成回复
• 更新状态
```

### 11.2 ReAct 模式详解

**ReAct = Reasoning + Acting（推理 + 行动）**

```
ReAct 模式的核心思想：
让 Agent 在行动前先"说出"自己的推理过程

格式：
Thought: [Agent 的思考过程]
Action: [决定采取的行动]
Observation: [行动的结果]
... (重复直到完成)
Final Answer: [最终回答]

示例：

用户任务："找出 src 目录下最大的 Python 文件"

─────────────────────────────────────────────
Thought: 用户想知道 src 目录下最大的 Python 文件。
        我需要先列出所有 .py 文件及其大小。
        
Action: 执行命令 "find src -name '*.py' -exec ls -la {} \;"

Observation: 
-rw-r--r-- 1 user 2048  src/main.py
-rw-r--r-- 1 user 15360 src/utils.py
-rw-r--r-- 1 user 8192  src/models.py
-rw-r--r-- 1 user 4096  src/config.py
─────────────────────────────────────────────
Thought: 我得到了文件列表和大小。
        从结果看，utils.py (15360 bytes) 是最大的。
        让我确认一下这个数值。

Action: 执行命令 "ls -lh src/utils.py"

Observation:
-rw-r--r-- 1 user 15K src/utils.py
─────────────────────────────────────────────
Thought: 确认了 utils.py 大小是 15K，是最大的文件。
        我现在可以回答用户了。

Final Answer: src 目录下最大的 Python 文件是 
             src/utils.py，大小约 15KB。
─────────────────────────────────────────────
```

### 11.3 工具调用机制

```
工具调用的完整流程：

1. LLM 决定调用工具
   ┌─────────────────────────────────────────┐
   │ LLM 输出：                              │
   │ {                                       │
   │   "tool": "read_file",                  │
   │   "parameters": {                       │
   │     "file_path": "/src/config.py"       │
   │   }                                     │
   │ }                                       │
   └─────────────────────────────────────────┘
                    │
                    ▼
2. 系统解析并执行
   ┌─────────────────────────────────────────┐
   │ Agent 框架：                            │
   │ • 解析 JSON                             │
   │ • 验证参数                              │
   │ • 调用对应的工具函数                    │
   │ • read_file("/src/config.py")          │
   └─────────────────────────────────────────┘
                    │
                    ▼
3. 返回结果给 LLM
   ┌─────────────────────────────────────────┐
   │ 工具结果：                              │
   │ {                                       │
   │   "status": "success",                  │
   │   "content": "# Config file\n..."       │
   │ }                                       │
   └─────────────────────────────────────────┘
                    │
                    ▼
4. LLM 处理结果，决定下一步
   ┌─────────────────────────────────────────┐
   │ LLM：                                   │
   │ "好的，我已经读取了配置文件。          │
   │  根据内容，我发现..."                  │
   └─────────────────────────────────────────┘
```

### 11.4 错误处理与重试

```
Agent 需要处理各种异常情况：

┌─────────────────────────────────────────────────────┐
│ 错误类型          │ Agent 的处理策略              │
├─────────────────────────────────────────────────────┤
│ 工具执行失败      │ 分析错误，尝试修正参数重试    │
│ 文件不存在        │ 搜索正确的文件路径            │
│ 权限不足          │ 提示用户或尝试替代方案        │
│ 超时              │ 简化操作或分批执行            │
│ 结果不符合预期    │ 重新思考，调整策略            │
└─────────────────────────────────────────────────────┘

错误处理示例：

用户："读取 /config/settings.yaml 的内容"

─────────────────────────────────────────────
Thought: 需要读取配置文件

Action: read_file("/config/settings.yaml")

Observation: Error: File not found
─────────────────────────────────────────────
Thought: 文件不存在。可能是路径不对。
        让我搜索一下这个文件在哪里。

Action: find_file("settings.yaml")

Observation: Found: /app/config/settings.yaml
─────────────────────────────────────────────
Thought: 找到了正确路径，重新读取

Action: read_file("/app/config/settings.yaml")

Observation: [文件内容...]
─────────────────────────────────────────────
```

### 11.5 实例：一个文件搜索 Agent 的执行过程

```
用户任务："在项目中找到所有包含 'deprecated' 注释的函数，
         并列出它们的位置和建议的替代方案"

Agent 执行过程：
═══════════════════════════════════════════════════════

步骤 1：理解任务
─────────────────────────────────────────────
Thought: 用户想找所有标记为 deprecated 的函数。
        我需要：
        1. 搜索包含 'deprecated' 的代码
        2. 识别出函数名和位置
        3. 查找是否有替代方案的说明

步骤 2：搜索代码
─────────────────────────────────────────────
Action: grep -r "deprecated" --include="*.py" .

Observation:
./src/utils.py:45:    # @deprecated: Use new_helper() instead
./src/utils.py:46:    def old_helper():
./src/api/v1.py:102:    """Deprecated: This endpoint will be removed"""
./src/api/v1.py:103:    def get_user_legacy():

步骤 3：分析结果
─────────────────────────────────────────────
Thought: 找到了 2 处 deprecated 标记：
        1. old_helper() 在 utils.py:46
        2. get_user_legacy() 在 api/v1.py:103
        
        第一个有明确的替代方案 new_helper()
        第二个没有说明，我需要查看上下文

步骤 4：获取更多上下文
─────────────────────────────────────────────
Action: read_file("./src/api/v1.py", lines="95-115")

Observation:
95:  def get_user(user_id: int):
96:      """Get user by ID - recommended method"""
97:      ...
102: """Deprecated: This endpoint will be removed"""
103: def get_user_legacy():
104:     """Use get_user() instead"""

步骤 5：整理结果
─────────────────────────────────────────────
Thought: 现在我有完整的信息了

Final Answer:
┌─────────────────────────────────────────────────────┐
│ 找到 2 个 deprecated 函数：                         │
│                                                     │
│ 1. old_helper()                                     │
│    位置：src/utils.py:46                           │
│    替代方案：new_helper()                           │
│                                                     │
│ 2. get_user_legacy()                               │
│    位置：src/api/v1.py:103                         │
│    替代方案：get_user()                             │
└─────────────────────────────────────────────────────┘
═══════════════════════════════════════════════════════
```

---

## 第12章：常见 Agent 架构模式

### 12.1 单 Agent 架构

```
最简单的架构：一个 Agent 处理所有任务

┌─────────────────────────────────────────────┐
│                                             │
│   用户 ◀──────────────────────▶ Agent       │
│                                   │         │
│                          ┌───────┴───────┐  │
│                          ▼       ▼       ▼  │
│                       Tool1   Tool2   Tool3 │
│                                             │
└─────────────────────────────────────────────┘

优点：
✅ 结构简单
✅ 易于理解和调试
✅ 上下文连贯

缺点：
❌ 能力有限于单个 LLM
❌ 复杂任务可能超出能力
❌ 工具过多时选择困难

适用场景：
• 任务相对简单
• 工具数量有限
• 对延迟敏感
```

### 12.2 多 Agent 协作

```
多个专门化的 Agent 协同工作

┌─────────────────────────────────────────────────────────┐
│                                                         │
│   用户 ◀──────▶ 协调者 Agent                            │
│                    │                                    │
│        ┌──────────┼──────────┐                         │
│        ▼          ▼          ▼                         │
│   ┌─────────┐ ┌─────────┐ ┌─────────┐                  │
│   │代码Agent│ │测试Agent│ │文档Agent│                  │
│   └────┬────┘ └────┬────┘ └────┬────┘                  │
│        │          │          │                         │
│    代码工具    测试工具    文档工具                      │
│                                                         │
└─────────────────────────────────────────────────────────┘

工作方式：
1. 协调者接收用户任务
2. 分解任务，分配给专门的 Agent
3. 各 Agent 独立执行
4. 协调者整合结果

示例场景：代码审查
├── 代码 Agent：检查代码质量和最佳实践
├── 安全 Agent：检查安全漏洞
├── 性能 Agent：分析性能问题
└── 协调者：整合所有建议
```

### 12.3 层级 Agent 系统

```
树状结构的 Agent 组织

┌─────────────────────────────────────────────────────────┐
│                                                         │
│                    ┌──────────┐                         │
│                    │ 主 Agent │                         │
│                    └────┬─────┘                         │
│                         │                               │
│          ┌──────────────┼──────────────┐               │
│          ▼              ▼              ▼               │
│    ┌──────────┐   ┌──────────┐   ┌──────────┐         │
│    │后端 Agent│   │前端 Agent│   │测试 Agent│         │
│    └────┬─────┘   └────┬─────┘   └────┬─────┘         │
│         │              │              │                │
│    ┌────┴────┐    ┌────┴────┐    ┌────┴────┐          │
│    ▼         ▼    ▼         ▼    ▼         ▼          │
│  数据库    API  组件      样式  单元     集成          │
│  Agent    Agent Agent    Agent 测试     测试          │
│                               Agent    Agent          │
│                                                         │
└─────────────────────────────────────────────────────────┘

特点：
• 任务逐级分解
• 每层 Agent 有明确职责
• 可以并行处理
• 适合大型复杂项目
```

### 12.4 Agent 与人类协作模式

```
不同的人机协作程度：

┌─────────────────────────────────────────────────────────┐
│                                                         │
│  完全自主                                               │
│  ════════                                               │
│  Agent 独立完成所有工作，人类只看结果                   │
│  适用：低风险、重复性任务                               │
│                                                         │
│  ──────────────────────────────────────────────────    │
│                                                         │
│  关键点确认（Human-in-the-Loop）                        │
│  ══════════════════════════════                         │
│  Agent 执行，在关键决策点请求人类确认                   │
│  适用：重要操作、不可逆操作                             │
│                                                         │
│  示例流程：                                             │
│  Agent："我将要删除这 10 个文件，确认吗？"             │
│  人类："确认" / "等等，让我看看"                       │
│                                                         │
│  ──────────────────────────────────────────────────    │
│                                                         │
│  协作模式                                               │
│  ════════                                               │
│  人类和 Agent 交替工作，互相补充                        │
│  适用：创意工作、复杂决策                               │
│                                                         │
│  示例流程：                                             │
│  人类：提出需求                                         │
│  Agent：生成初稿                                        │
│  人类：反馈修改意见                                     │
│  Agent：根据反馈修改                                    │
│  ...                                                    │
│                                                         │
│  ──────────────────────────────────────────────────    │
│                                                         │
│  人类主导                                               │
│  ════════                                               │
│  人类做主要工作，Agent 提供建议和辅助                   │
│  适用：需要专业判断、高风险场景                         │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

---

## 本章小结

```
核心要点回顾：

1. Agent 是什么
   ├── 能自主感知、决策、行动的 AI 系统
   ├── 与纯 LLM 的区别：能"做"不只是"说"
   └── 解决了 LLM 无法执行实际操作的问题

2. 四大核心组件
   ├── 大脑（LLM）：思考与决策
   ├── 记忆（Memory）：短期与长期存储
   ├── 工具（Tools）：与外部世界交互
   └── 规划（Planning）：任务分解与执行

3. 工作流程
   ├── 感知-思考-行动循环
   ├── ReAct 模式：推理 + 行动
   └── 错误处理与重试机制

4. 架构模式
   ├── 单 Agent：简单任务
   ├── 多 Agent：专业分工
   ├── 层级系统：复杂项目
   └── 人机协作：不同自主程度
```

---

**下一章 → [第13章：Skills 概念与作用](./04-skills.md)**
